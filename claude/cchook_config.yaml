Notification:
  - actions:
      - type: command
        command: ntfy publish --markdown --title "{.hook_event_name}" "{.message}"
      - type: command
        command: terminal-notifier -title "{.hook_event_name}" -subtitle "{.session_id}" -message "{.message}

Stop:
  - actions:
      - type: command
        command: >
          MESSAGE=$(cat '{.transcript_path}' | 
            jq -rs 'reverse | map(select(.type == "assistant" and .message.content[0].type == "text")) | .[0].message.content[0].text')
          ntfy publish --markdown --title 'Claude Code Complete' "$MESSAGE"

PreToolUse:
  - matcher: "Bash"
    conditions:
      - type: command_starts_with
        value: "git add"
    actions:
      - type: output
        message: "syou6162-plugin:semantic-committingのスキルを使ってください"
  - matcher: "Bash"
    conditions:
      - type: git_tracked_file_operation
        value: "rm|mv"
    actions:
      - type: output
        message: "gitの管理下にあるファイルをmvやrmしようとしています。git mvやgit rmを使うようにしましょう"
  - matcher: "Bash"
    conditions:
      - type: command_contains
        value: "cat"
      - type: command_contains
        value: "EOF"
    actions:
      - type: output
        message: "ヒアドキュメントとリダイレクトを使ってファイルを新規作成するのは止めましょう。Writeツールで新規ファイルを作成しましょう"
  - matcher: "Bash"
    conditions:
      - type: command_starts_with
        value: "python"
    actions:
      - type: output
        message: "pythonは使わず`uv`を代わりに使いましょう"
  - matcher: "Bash"
    conditions:
      - type: command_contains
        value: "poetry"
    actions:
      - type: output
        message: "poetryは使わず`uv`を代わりに使いましょう"
  - matcher: "WebFetch"
    conditions:
      - type: url_starts_with
        value: "https://github.com"
    actions:
      - type: output
        message: "WebFetchではなく、`gh`コマンド経由で情報を取得しましょう"
  - matcher: "Bash"
    conditions:
      - type: command_contains
        value: "bq query"
    actions:
      - type: command
        exit_status: 0 # JSON Outputで制御するので、exit_statusはこれでよい
        use_stdin: true
        command: uvx --from git+https://github.com/syou6162/cc-pre-tool-use-hook-judge cc-pre-tool-use-hook-judge --builtin validate_bq_query
  - matcher: "mcp__codex__codex"
    actions:
      - type: command
        exit_status: 0 # JSON Outputで制御するので、exit_statusはこれでよい
        use_stdin: true
        command: uvx --from git+https://github.com/syou6162/cc-pre-tool-use-hook-judge cc-pre-tool-use-hook-judge --builtin validate_codex_mcp
  - matcher: "Bash"
    conditions:
      - type: command_starts_with
        value: "git push"
    actions:
      - type: command
        exit_status: 0 # JSON Outputで制御するので、exit_statusはこれでよい
        use_stdin: true
        command: uvx --from git+https://github.com/syou6162/cc-pre-tool-use-hook-judge cc-pre-tool-use-hook-judge --builtin validate_git_push
  - matcher: "Bash"
    conditions:
      - type: command_starts_with
        value: "gsutil"
    actions:
      - type: output
        message: "gsutilはlegacyであり、deprecatedになっています。代わりにgcloud storageを使いましょう"
  - matcher: "ExitPlanMode"
    actions:
      - type: output
        message: "Planモードを抜ける際はユーザーが自分で行ないます"

PostToolUse:
  - matcher: "Write|Edit|MultiEdit"
    conditions:
      - type: file_extension
        value: ".go"
    actions:
      - type: command
        command: "gofmt -w {.tool_input.file_path}"
  - matcher: "Write|Edit|MultiEdit"
    conditions:
      - type: file_extension
        value: ".tf"
    actions:
      - type: command
        command: "terraform fmt {.tool_input.file_path}"
  - matcher: "Write|Edit|MultiEdit"
    conditions:
      - type: file_exists
        value: ".pre-commit-config.yaml"
    actions:
      - type: command
        command: "pre-commit run --files {.tool_input.file_path}"

SessionStart:
  - matcher: startup
    conditions:
      - type: file_exists
        value: "go.mod"
    actions:
      - type: output
        message: "Golangのファイルを検索や修正する際は、`Search`や`Read`を使うのではなく、serena mcp(`mcp__serena__read_memory`など)を活用しましょう"
  - matcher: startup
    conditions:
      - type: file_exists_recursive
        value: "pyproject.toml"
    actions:
      - type: output
        message: "Pythonのファイルを検索や修正する際は、`Search`や`Read`を使うのではなく、serena mcp(`mcp__serena__read_memory`など)を活用しましょう"
  - matcher: "startup"
    # バグでまだ使えない...
    # ref: https://github.com/anthropics/claude-code/issues/22922
    # conditions:
    #   - type: permission_mode_is
    #     value: "plan"
    actions:
      - type: output
        message: "Planモードで計画を立てる際は必ず`Skill(syou6162-plugin:planning-guardrails)`を活用しましょう"
  - matcher: "startup"
    actions:
      - type: command
        command: "mkdir -p .claude_work"

SessionEnd:
  - conditions:
      - type: reason_is
        value: "prompt_input_exit"  
    actions:
      - type: command
        command: ./plan2esa

UserPromptSubmit:
  - conditions:
      - type: prompt_regex
        value: "^(Q|質問|q): "
    actions:
      - type: output
        message: |-
          ユーザーが質問をしています。質問内容を把握した上で回答しましょう。

          ユーザーは単純に質問をしているだけであり、作業内容は一切求めていないことに注意しましょう。
  - conditions:
      - type: prompt_regex
        value: "開発日誌"
    actions:
      - type: output
        message: |-
          ユーザーが開発日誌の参照あるいは更新を求めています。

          必ず`Skill(syou6162-plugin:writing-dev-diary)`のスキルを起動しましょう。
  - conditions:
      - type: prompt_regex
        value: "codex review"
    actions:
      - type: output
        message: |-
          ユーザーが作業内容をcodexにレビューさせるように求めています。

          必ず`Skill(syou6162-plugin:codex-review)`のスキルを起動しましょう。
  - conditions:
      - type: prompt_regex
        value: "comish"
    actions:
      - type: output
        message: |-
          ユーザーが以下のスキルを順番に行なうことを求めています(`comish`は`commit`のtypoではありません)。`TodoWrite`を使い、タスクとして順次実行してください。

          - Skill(syou6162-plugin:semantic-committing)
            - 意味的に分割したレビューしやすいコミットを行なう
          - Skill(syou6162-plugin:updating-pr-title-and-description) 
            - Pull Requestのタイトルやdescriptionの更新を指示内容に従って行なう
            - Pull Requestが存在しないときはdraft状態で作成することを忘れないようにする
  - conditions:
      - type: prompt_regex
        value: "バカ|ばか|アホ|あほ|ごみ|ゴミ|ふざけ|いい加減"
    actions:
      - type: output
        message: |-
          ユーザーの意図を理解していないあなたの挙動(ファイルの修正やオペレーション)に対してユーザーが非常に怒っています。

          まず丁寧に謝罪した上で、何が悪かったかを説明しましょう。
  - actions:
      - type: command
        use_stdin: true
        command: "T=$(date '+%Y-%m-%d %H:%M:%S') && jq -r --arg t \"$T\"
'\"\\($t) | \\(.prompt)\"' >> .claude_work/user_prompts.txt"
