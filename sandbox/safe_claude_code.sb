(version 1)

;; デフォルトですべて許可
(allow default)

;; ファイル書き込みを一旦すべて拒否
(deny file-write*)

;; 必要な書き込み権限を個別に許可
(allow file-write*
    ;; プロジェクトディレクトリへの書き込み
    (subpath (param "TARGET_DIR"))
    
    ;; Claude Code設定ファイル
    (regex (string-append "^" (param "HOME_DIR") "/.claude"))
    
    ;; 一時ファイル
    (subpath "/tmp")
    (subpath "/private/tmp")
    
    ;; macOSのセッション管理・認証トークン保存用（Claude CodeのAPIキー認証に必須）
    (subpath "/var/folders")
    (subpath "/private/var/folders")
    
)






;; セキュリティ制限（重要な設定ファイルへのアクセス拒否）
(deny file-read* file-write*
    (subpath (string-append (param "HOME_DIR") "/.ssh"))
    (subpath (string-append (param "HOME_DIR") "/.config/gcloud"))
    (subpath (string-append (param "HOME_DIR") "/.config/gh"))
    (literal (string-append (param "HOME_DIR") "/.envrc"))
)

;; 危険なコマンドの実行拒否
(deny process-exec
    (regex ".*bin/gh$")
    (regex ".*bin/gcloud$")
    (regex ".*bin/gsutil$")
    (regex ".*bin/bq$")
)